---
title: "Untitled"
author: "Anastasia Bernat"
date: "5/12/2021"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
library(readxl)
library(dplyr)

dir = "/Users/anastasiabernat/Desktop/git_repositories/xml-archive/search_engine/"
setwd(dir)
knitr::opts_chunk$set(echo = TRUE)
```

## Read XLS file and remove unnecessary

1) Read XLS file

```{r message=FALSE}
data2 <- read_excel("savedrecs-2.xls")
data3 <- read_excel("savedrecs-3.xls")
data4 <- read_excel("savedrecs-4.xls")

cite1 <- read_excel("yr_citations.xls")
cite2 <- read_excel("yr_citations-2.xls")
cite3 <- read_excel("yr_citations-3.xls")

cols = c("Title","Authors","Corporate Authors","Editors","Book Editors","Source Title","Publication Date","Publication Year","Volume","Issue","Part Number","Supplement","Special Issue","Beginning Page","Ending Page","Article Number","DOI","Conference Title","Conference Date","Total Citations","Average per Year","1900","1901","1902","1903","1904","1905","1906","1907","1908","1909","1910","1911","1912","1913","1914","1915","1916","1917","1918","1919","1920","1921","1922","1923","1924","1925","1926","1927","1928","1929","1930","1931","1932","1933","1934","1935","1936","1937","1938","1939","1940","1941","1942","1943","1944","1945","1946","1947","1948","1949","1950","1951","1952","1953","1954","1955","1956","1957","1958","1959","1960","1961","1962","1963","1964","1965","1966","1967","1968","1969","1970","1971","1972","1973","1974","1975","1976","1977","1978","1979","1980","1981","1982","1983","1984","1985","1986","1987","1988","1989","1990","1991","1992","1993","1994","1995","1996","1997","1998","1999")

clean_cite_data = function(d, cnames) {
  colnames(d) = cnames
  d = d[29:nrow(d),]
  return(d)
}

cite1 = clean_cite_data(cite1, cols)
cite2 = clean_cite_data(cite2, cols)
cite3 = clean_cite_data(cite3, cols)

data = rbind(data2,data3,data4)
cites = rbind(cite1, cite2, cite3)
```

2) Remove unnecessary columns 

```{r warning=FALSE, message=FALSE}
remove_cols = c("Book Authors", "Book Editors", "Book Group Authors", "Book Author Full Names", 
                "Group Authors", "Book Series Title", "Book Series Subtitle", "Book DOI", 
                "Conference Title", "Conference Date", "Conference Location", "Conference Sponsor",
                "Conference Host", "Funding Orgs", "Funding Text", "Cited References", "ISBN",
                "Supplement", "Early Access Date", "...68", "Journal Abbreviation", 
                "Journal ISO Abbreviation", "WoS Categories", "Research Areas")
drop_identifiers = c("Email Addresses", "Researcher Ids", "ORCIDs", "ISSN", 
                     "eISSN", "IDS Number", "UT (Unique WOS ID)", "Pubmed Id")
drop_nuances = c("Cited Reference Count", "Times Cited, WoS Core", 
                 "180 Day Usage Count", "Highly Cited Status", "Hot Paper Status")

d = data %>%
  select(-remove_cols) %>%
  select(-drop_identifiers) %>%
  select(-drop_nuances)
```

```{r}
remove_cols = c("Corporate Authors","Editors","Book Editors","Supplement","Special Issue","Conference Title","Conference Date")

c = cites %>%
  select(-remove_cols)
```

3) Clean inconsistent data entries

```{r}
c$`Publication Year` = as.numeric(c$`Publication Year`)
```

4) Order the data by year and article title 

```{r}
do = d[order(-d$`Publication Year`, d$`Article Title`),]
co = c[order(-c$`Publication Year`, c$Title),]
```

## Filtering

1) Filter out duplicates

```{r}
df = do[!duplicated(do$`Article Title`),]
cf = co[!duplicated(co$Title),]
```

2) Determine citation year range (str). 

```{r warning=FALSE}
r = c()
s = c()
e = c()
for (i in 1:nrow(cf)) { 
  yrs = unlist(cf[i,15:length(cf)])

  if (sum(yrs) == 0) {
    range = ""
    r = c(r, range)
    s = c(s, range)
    e = c(e, range)
  }
  if (sum(yrs) > 0) {
    yrscited = which(yrs > 1)
    
    if (length(yrscited) == 0) {
      range = ""
      r = c(r, range)
      s = c(s, range)
      e = c(e, range)
    }
    if (length(yrscited) == 1) {
      range = names(yrscited)
      r = c(r, range)
      s = c(s, range)
      e = c(e, range)
    }
    if (length(yrscited) > 1) {
      all_yrs = (as.numeric(names(yrscited)))
      start_yr = min(all_yrs)
      end_yr = max(all_yrs)
      range = paste0(start_yr,"-", end_yr)
      r = c(r, range)
      s = c(s, start_yr)
      e = c(e, end_yr)
    }
  }
}
length(r)
length(s)
length(e)
```

```{r warning=FALSE}
cf$YrRange = r
cf$YrStart = s
cf$YrEnd = e

df$YrRange = r
df$YrStart = s
df$YrEnd = e
```

3) Compute the number times cited from 1900-1999.

```{r}
years = cf[,18:length(cf)-3]
cf$CiteT = rowSums(years) 
df$CiteT = cf$CiteT
```

4) Compare citation metrics.

```{r}
df$CiteX = df$`Times Cited, All Databases` - df$`Since 2013 Usage Count`
cbind(df$CiteT,df$CiteX)[1:10,] 
```

It is probably the case that 2000 onwards, papers were cited much more frequently and it shows: http://apps.webofknowledge.com.proxy.uchicago.edu/summary.do?product=WOS&parentProduct=WOS&search_mode=CitationReport&qid=3&SID=5C1gNouD5pzsDOQyCCj&&page=1&action=sort&sortBy=PY.A;LD.A;SO.A.en;VL.A;PG.A;AU.A.en&showFirstPage=1&isCRHidden=false.

5) Create a plot that shows the year range on the x axis and on the y the number of times cited.

```{r}
t_col <- function(color, percent = 70, name = NULL) {
  rgb.val <- col2rgb(color)
  t.col <- rgb(rgb.val[1], rgb.val[2], rgb.val[3],
             max = 255,
             alpha = (100 - percent) * 255 / 100,
             names = name)
invisible(t.col)
}
```

```{r}
dp = cbind(as.numeric(df$CiteT),
      as.numeric(df$CiteX), 
      as.numeric(df$YrStart), 
      as.numeric(df$YrEnd))
dp = as.data.frame(dp)
colnames(dp) = c("CiteT", "CiteX", "YrStart", "YrEnd")
dp = dp[complete.cases(dp),]

plot(1, type="n", xlab="Year", ylab="Number of Citations Per Year Range", 
     xlim=c(1920,1999), ylim=c(0,610), 
     main="blue <=20 yr range | black = remaining")
for (i in 1:nrow(dp)){
  if (dp$YrEnd[i]-dp$YrStart[i] <=20) {
    lines(c(dp$YrStart[i], dp$YrEnd[i]), c(dp$CiteT[i], dp$CiteT[i]), type="l", col="blue")
  }
  else {
    lines(c(dp$YrStart[i], dp$YrEnd[i]), c(dp$CiteT[i], dp$CiteT[i]), type="l", col=t_col("black"))}
}
```

6) Compute some weighted or comparable factor.

```{r}
df$YrEnd = as.numeric(df$YrEnd)
df$YrStart = as.numeric(df$YrStart)
temp = df %>%
  filter(!is.na(YrEnd), !is.na(YrStart))
temp$Weight = temp$CiteT / (temp$YrEnd - temp$YrStart)
sort(temp$Weight)
# n_citations / range 
# If greater than 1 then citing more than once per year
# If lower than 1 then citing less than once per year
```

7) Assess zero-inflation.

```{r}
sum(df$CiteT == 0) / sum(df$CiteT) * 100 # Very low - only 0.36% zeros so let's keep the zeros
```

8) Create the masterlist.

a) Remove papers with citation counts of <= 0

```{r}
dd = df[df$CiteT >= 0, ] # all articles remained (there are no negatives)
```

b) Order by descending publication year and citation number. Store the intermediary step.

```{r}
dt = dd[order(-dd$`Publication Year`, -dd$CiteX),]
```

```{r}
write.csv(dt, "filtered_articles2.csv") 
```

c) Get top 10% or bottom 10% cited.

```{r}
unique(dt$`Publication Year`) # notice that there were no papers published before 1920
```

```{r}
# Top and bottom 10% 

q = 0.10
start_year = 1920
top_list = c()
bottom_list = c()
for (i in 1:8) {
  end_year = start_year + 10
  cat("Decade:", start_year, "to", end_year, "\n")
  
  df_decade = dt[dt$`Publication Year` >= start_year & dt$`Publication Year` < end_year,]
  df_sorted = df_decade[order(-df_decade$CiteT),]
  
  top5 = quantile(df_sorted$CiteT,  1-q)
  bottom5 = quantile(df_sorted$CiteT,  q)
  
  top = c()
  bottom = c()
  for (row in 1:nrow(df_sorted)) {
    paper = df_sorted[row, ]$`Article Title`
    cite_n = df_sorted[row, ]$CiteT
    if (cite_n > top5) {
      top = c(top, paper)
    }
    if (cite_n > bottom5) {
      bottom = c(bottom, paper)
    }
  }
  
  if (length(top) < 5) {read_nt = 3}
  else{read_nt=5}
  if (length(bottom) < 5) {read_nb = 3}
  else{read_nb=5}
  
  top_reading = sample(top, size=read_nt, replace=F)
  bottom_reading = sample(bottom, size=read_nb, replace=F)
  
  print(top_reading)
  print(bottom_reading)
  
  top_list = c(top_list, start_year)
  top_list = c(top_list, top_reading)
  bottom_list = c(bottom_list, start_year)
  bottom_list = c(bottom_list, bottom_reading)
  
  start_year = end_year
  
}
```

```{r}
datat = as.data.frame(top_list)
datat$group = "top"
datab = as.data.frame(bottom_list)
datab$group = "bottom"
colnames(datat) = c("", paste0("group",q))
colnames(datab) = c("", paste0("group",q))

masterlist = rbind(datat, datab)
masterlist$reader = ""

masterlist
```

## Write as a CSV file

```{r}
write.csv(masterlist, "masterlist3.csv") 
```
